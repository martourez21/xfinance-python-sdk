name: Python CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Validate pyproject.toml
      run: |
        python -c "
        try:
            import tomllib
            with open('pyproject.toml', 'rb') as f:
                tomllib.load(f)
            print('âœ… pyproject.toml is valid TOML')
        except Exception as e:
            print(f'âŒ pyproject.toml validation failed: {e}')
            exit(1)
        "

    - name: Check package structure
      run: |
        echo "Checking package structure..."
        if [ -d "xfinance_sdk" ]; then
            echo "âœ… xfinance_sdk directory exists"
        else
            echo "âŒ xfinance_sdk directory missing"
            exit 1
        fi
        
        if [ -f "xfinance_sdk/__init__.py" ]; then
            echo "âœ… xfinance_sdk/__init__.py exists"
        else
            echo "âŒ xfinance_sdk/__init__.py missing"
            exit 1
        fi

  build:
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build

    - name: Build package
      run: |
        python -m build

    - name: List built packages
      run: |
        ls -la dist/

  skip-tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Skip tests notification
      run: |
        echo "ðŸ§ª Tests are currently skipped due to pyproject.toml configuration issues"
        echo "Once the configuration is fixed, tests will be re-enabled"
        echo "Current focus: Building and validation only"

  docs:
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install minimal dependencies for docs
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx-rtd-theme

    - name: Build documentation (basic)
      run: |
        if [ -d "docs" ] && [ -f "docs/conf.py" ]; then
            echo "Building existing documentation..."
            cd docs
            sphinx-build -b html . _build/html
        else
            echo "No existing docs found, creating basic structure..."
            mkdir -p docs
            echo "# xfinance Python SDK Documentation" > docs/index.md
            echo "## Getting Started" >> docs/index.md
            echo "This is the documentation for xfinance Python SDK." >> docs/index.md
            mkdir -p docs/_build/html
            echo "<html><body><h1>xfinance Python SDK</h1><p>Documentation is being set up.</p></body></html>" > docs/_build/html/index.html
        fi

    - name: Setup GitHub Pages
      uses: actions/configure-pages@v5

    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/_build/html/

    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4